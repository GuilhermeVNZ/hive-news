# üöÄ Nginx Configuration com Otimiza√ß√µes de Infraestrutura
# 
# Este arquivo cont√©m configura√ß√µes otimizadas para:
# - HTTP/3 + QUIC
# - AVIF/WebP conversion
# - Cache forte
# - Early Hints (103)
# - Brotli compression
# - Gzip fallback

# Upstream para aplica√ß√µes
upstream airesearch_backend {
    server localhost:3000;
    keepalive 32;
}

upstream scienceai_backend {
    server localhost:5173;
    keepalive 32;
}

# Cache zone para proxy
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=1g inactive=60m use_temp_path=off;

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=static_limit:10m rate=50r/s;

# ========================================
# AIResearch (Next.js)
# ========================================
server {
    listen 80;
    listen [::]:80;
    server_name airesearch.news www.airesearch.news;
    
    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    # HTTP/3 (443 QUIC) - requer nginx com m√≥dulo HTTP/3 compilado
    listen 443 http3 reuseport;
    listen [::]:443 http3 reuseport;
    
    # Fallback HTTP/2 (se HTTP/3 n√£o dispon√≠vel)
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    
    server_name airesearch.news www.airesearch.news;
    
    root /opt/news-system/apps/frontend-next/airesearch/.next;
    
    # ========================================
    # SSL Configuration
    # ========================================
    ssl_certificate /etc/letsencrypt/live/airesearch.news/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/airesearch.news/privkey.pem;
    
    # Modern SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_stapling on;
    ssl_stapling_verify on;
    
    # HTTP/3 Alt-Svc header (informa ao cliente que HTTP/3 est√° dispon√≠vel)
    add_header Alt-Svc 'h3=":443"; ma=86400' always;
    
    # ========================================
    # Security Headers
    # ========================================
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    
    # ========================================
    # Compression
    # ========================================
    # Brotli (preferido - melhor compress√£o que Gzip)
    brotli on;
    brotli_comp_level 6;
    brotli_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/rss+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml;
    
    # Gzip (fallback para navegadores antigos)
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/rss+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml;
    gzip_min_length 1000;
    gzip_disable "msie6";
    
    # ========================================
    # Static Assets - Cache Forte (1 ano)
    # ========================================
    location ~* ^/_next/static/ {
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header Pragma "public";
        add_header Vary "Accept-Encoding";
        
        # ETag para valida√ß√£o condicional
        etag on;
        
        # Brotli/Gzip
        brotli_static on;
        gzip_static on;
        
        try_files $uri =404;
    }
    
    # ========================================
    # Images - AVIF/WebP com Fallback
    # ========================================
    location ~* ^/images/.*\.(jpg|jpeg|png|webp)$ {
        root /opt/news-system;
        
        # Verificar suporte AVIF via Accept header
        set $avif_supported "";
        if ($http_accept ~* "image/avif") {
            set $avif_supported "1";
        }
        
        # Verificar suporte WebP
        set $webp_supported "";
        if ($http_accept ~* "image/webp") {
            set $webp_supported "1";
        }
        
        # Tentar servir AVIF primeiro
        if ($avif_supported = "1") {
            rewrite ^/images/(.+\.(jpg|jpeg|png|webp))$ /images/$1.avif last;
        }
        
        # Fallback para WebP
        if ($webp_supported = "1") {
            rewrite ^/images/(.+\.(jpg|jpeg|png))$ /images/$1.webp last;
        }
        
        # Cache forte para imagens
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header Pragma "public";
        add_header Vary "Accept";
        
        # ETag
        etag on;
        
        try_files $uri =404;
    }
    
    # Servir AVIF quando dispon√≠vel
    location ~* ^/images/.*\.avif$ {
        root /opt/news-system;
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header Content-Type "image/avif";
        add_header Vary "Accept";
        etag on;
        try_files $uri =404;
    }
    
    # Servir WebP quando dispon√≠vel
    location ~* ^/images/.*\.webp$ {
        root /opt/news-system;
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header Content-Type "image/webp";
        add_header Vary "Accept";
        etag on;
        try_files $uri =404;
    }
    
    # Fontes - Cache forte (1 ano)
    location ~* \.(woff|woff2|ttf|eot|otf)$ {
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header Access-Control-Allow-Origin "*";
        add_header Vary "Accept-Encoding";
        brotli_static on;
        gzip_static on;
        etag on;
        try_files $uri =404;
    }
    
    # ========================================
    # API Routes - Cache Curto (5 minutos)
    # ========================================
    location /api/ {
        limit_req zone=api_limit burst=20 nodelay;
        
        proxy_pass http://airesearch_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Cache para API (5 minutos)
        proxy_cache api_cache;
        proxy_cache_valid 200 5m;
        proxy_cache_valid 404 1m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        proxy_cache_lock on;
        
        add_header Cache-Control "public, max-age=300, s-maxage=300, stale-while-revalidate=600";
        add_header X-Cache-Status $upstream_cache_status;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # ========================================
    # Early Hints (103) - Recursos Cr√≠ticos
    # ========================================
    location / {
        proxy_pass http://airesearch_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Early Hints: pr√©-carregar recursos cr√≠ticos (HTTP/2 Push ou 103)
        http2_push_preload on;
        
        # Headers para Early Hints (103)
        # Nota: HTTP 103 √© enviado antes do 200 OK
        add_header Link "</_next/static/css/app.css>; rel=preload; as=style" always;
        add_header Link "</_next/static/chunks/main.js>; rel=preload; as=script" always;
        add_header Link "</fonts/inter.woff2>; rel=preload; as=font; type=font/woff2; crossorigin" always;
        
        # Cache para HTML (1 hora - ISR do Next.js)
        expires 1h;
        add_header Cache-Control "public, max-age=3600, s-maxage=3600, stale-while-revalidate=86400";
    }
    
    # ========================================
    # Health Check
    # ========================================
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # ========================================
    # Logs
    # ========================================
    access_log /var/log/nginx/airesearch-access.log;
    error_log /var/log/nginx/airesearch-error.log;
}

# ========================================
# ScienceAI (Vite/React)
# ========================================
server {
    listen 80;
    listen [::]:80;
    server_name scienceai.news www.scienceai.news;
    
    return 301 https://$server_name$request_uri;
}

server {
    # HTTP/3 (443 QUIC)
    listen 443 http3 reuseport;
    listen [::]:443 http3 reuseport;
    
    # Fallback HTTP/2
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    
    server_name scienceai.news www.scienceai.news;
    
    root /opt/news-system/apps/frontend-next/scienceai/dist;
    index index.html;
    
    # SSL Configuration (mesmo que acima)
    ssl_certificate /etc/letsencrypt/live/scienceai.news/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/scienceai.news/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    
    # HTTP/3 Alt-Svc
    add_header Alt-Svc 'h3=":443"; ma=86400' always;
    
    # Security Headers (mesmo que acima)
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Compression (mesmo que acima)
    brotli on;
    brotli_comp_level 6;
    brotli_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript image/svg+xml;
    
    gzip on;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript image/svg+xml;
    
    # Images - AVIF/WebP (mesmo que acima)
    location ~* ^/images/.*\.(jpg|jpeg|png|webp)$ {
        alias /opt/news-system/images/;
        set $avif_supported "";
        if ($http_accept ~* "image/avif") {
            set $avif_supported "1";
        }
        if ($avif_supported = "1") {
            rewrite ^/images/(.+\.(jpg|jpeg|png|webp))$ /images/$1.avif last;
        }
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header Vary "Accept";
        etag on;
        try_files $uri =404;
    }
    
    # Static Assets (CSS, JS)
    location ~* \.(js|css|woff|woff2|ttf|eot|svg|ico)$ {
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header Vary "Accept-Encoding";
        brotli_static on;
        gzip_static on;
        etag on;
        try_files $uri =404;
    }
    
    # API Proxy
    location /api/ {
        limit_req zone=api_limit burst=20 nodelay;
        
        proxy_pass http://scienceai_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache (5 minutos)
        proxy_cache api_cache;
        proxy_cache_valid 200 5m;
        add_header Cache-Control "public, max-age=300, s-maxage=300";
        add_header X-Cache-Status $upstream_cache_status;
    }
    
    # SPA Fallback
    location / {
        try_files $uri $uri/ /index.html;
        
        # Cache para HTML (1 hora)
        expires 1h;
        add_header Cache-Control "public, max-age=3600, s-maxage=3600";
        
        # Early Hints
        http2_push_preload on;
        add_header Link "</assets/css/index.css>; rel=preload; as=style" always;
        add_header Link "</assets/js/index.js>; rel=preload; as=script" always;
    }
    
    access_log /var/log/nginx/scienceai-access.log;
    error_log /var/log/nginx/scienceai-error.log;
}













