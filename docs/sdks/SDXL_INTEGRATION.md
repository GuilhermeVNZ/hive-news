# 🖼️ SDXL Integration Guide

**Version:** 1.0.0  
**Last Updated:** 2025-10-26  
**Module:** Image Generator (Module 9)

---

## 📍 Location Decision

Based on DAG analysis and module dependencies:

### ✅ Recommended Structure

```
News-main/
├── apps/
│   └── backend-cmmv/
│       └── modules/
│           └── image-generator/        # Image generation module
│               ├── contracts/
│               │   └── ImageContract.ts
│               ├── services/
│               │   └── sdxl-client.ts   # SDXL HTTP client
│               └── utils/
│                   └── image-processor.ts
│
└── storage/                            # External storage
    └── images/                         # Generated images (MinIO/S3)
        ├── covers/                     # Cover images
        ├── thumbnails/                  # Thumbnail images
        └── social/                     # Social media presets
```

### Why This Structure?

1. **Module 9 (Image Generator) is INSIDE backend-cmmv**
   - Located: `apps/backend-cmmv/modules/image-generator/`
   - Follows CMMV contract pattern
   - Service layer connects to SDXL

2. **Image Files are EXTERNAL**
   - Stored in MinIO/S3 bucket
   - Path: `s3://hivenews/images/{portal}/{type}/{id}.jpg`
   - NOT in git

3. **SDXL Models Stay Separate**
   - Recommendation: `News-main/sdxl/models/` (or external)
   - Models too large for git
   - Accessed by SDXL client

---

## 🔗 Module 9: Image Generator

### Contract: ImageContract

**Fields:**

```typescript
@Contract("Image")
export class ImageContract {
  @Field() id: string;
  @Field() article_id: string; // Links to ArticleContract
  @Field() style: string; // Portal-specific style
  @Field() prompt: string; // SDXL prompt used
  @Field() url_cover: string; // S3 URL for cover
  @Field() url_thumb: string; // S3 URL for thumbnail
  @Field() alt_text: string; // ALT text for SEO
  @Field() seo_relevance: number; // SEO score
}
```

### Dependencies (from DAG.md lines 212-217):

```
Article → Writer/Translator → Image Generator
                                │
                                ├─→ Generate with SDXL
                                ├─→ Upload to MinIO/S3
                                └─→ Store URLs in ImageContract
```

---

## 📂 Folder Structure Connected to Module 9

### 1. Backend Module (Generate)

```typescript
// apps/backend-cmmv/modules/image-generator/
├── contracts/
│   └── Image.contract.ts          // CMMV contract definition
├── services/
│   ├── SdxlClient.ts              // SDXL HTTP client
│   ├── ImageProcessor.ts          // Image processing utilities
│   └── MinIOClient.ts             // S3 upload/download
└── controllers/
    └── ImageController.ts         // Auto-generated by CMMV
```

### 2. Storage Layer (Persist)

```typescript
// MinIO/S3 Bucket Structure
s3://hivenews/
└── images/
    ├── airesearch/
    │   ├── covers/
    │   │   └── {article_id}.jpg
    │   ├── thumbnails/
    │   │   └── {article_id}_thumb.jpg
    │   └── social/
    │       ├── x/
    │       │   └── {article_id}_x.jpg
    │       └── linkedin/
    │           └── {article_id}_li.jpg
    └── scienceai/
        └── [same structure]
```

### 3. Database (Metadata)

```typescript
// PostgreSQL - ImageContract entity
images/
└── id (PK)
└── article_id (FK → articles)
└── url_cover (S3 URL)
└── url_thumb (S3 URL)
└── seo_relevance (FLOAT)
└── created_at (TIMESTAMP)
```

---

## 🔄 Data Flow

```
SDXL Generation Flow:
─────────────────────
ArticleContract (id: "abc123")
  ↓
Image Generator triggered
  ↓
Generate with SDXL (from News-main/sdxl/models/)
  ↓
1. Cover image (1200x675) → upload to MinIO → get URL
2. Thumbnail (400x400) → upload to MinIO → get URL
3. Social presets → upload to MinIO → get URLs
  ↓
Create ImageContract record:
  - article_id: "abc123"
  - url_cover: "s3://hivenews/images/airesearch/covers/abc123.jpg"
  - url_thumb: "s3://hivenews/images/airesearch/thumbnails/abc123_thumb.jpg"
  ↓
Store in PostgreSQL
```

---

## 🎯 What You Need to Do for SDXL

### Option A: Local SDXL (Recommended for Development)

**Installation:**

```bash
# 1. Create directory
mkdir News-main/sdxl
cd News-main/sdxl

# 2. Download models (or I can create download script)
# Models go in: sdxl/models/
# - sd_xl_base_1.0.safetensors
# - sd_xl_refiner_1.0.safetensors

# 3. Run SDXL server
python scripts/sdxl-server.py --port 7860
```

**Files Needed:**

- Models: `News-main/sdxl/models/*.safetensors` (~13.5 GB)
- Configs: `News-main/sdxl/configs/*.yaml` (create these)
- Server: `News-main/sdxl/scripts/sdxl-server.py` (I'll create this)

### Option B: Hosted SDXL (Production)

Use external SDXL API:

- Replicate.com
- Stability AI
- Hugging Face Inference API

---

## 📝 Where SDXL Generates Images

1. **SDXL generates image** → Temporary buffer
2. **Image uploaded to MinIO** → `s3://hivenews/images/...`
3. **ImageContract stores URL** → PostgreSQL
4. **Article references image** → Via `article_id` FK

**Image files NEVER go in git.** Only metadata (URLs) are stored.

---

## 🎨 Portal-Specific Configurations

### For each portal:

```yaml
# configs/portal-profiles/airesearch.yaml (already exists)
editorial:
  name: AIResearch
  image_style: "scientific, modern, tech-focused"
  cover_preset: "academic paper style"
  thumbnail_style: "minimalist, abstract"
```

This feeds into SDXL prompt generation.

---

## ✅ Summary for You

**Question:** Where should SDXL files go?

**Answer:**

1. **SDXL models:** `News-main/sdxl/models/` (or separate location if space limited)
2. **SDXL configs:** Will be created in `News-main/sdxl/configs/`
3. **Generated images:** Upload to MinIO/S3, NOT in git
4. **Image metadata:** Stored in ImageContract (PostgreSQL)

**Module:** Module 9 (Image Generator)  
**Location:** `apps/backend-cmmv/modules/image-generator/`  
**Connects to:** ArticleContract, MinIO/S3 storage, Publisher module

**Next Step:** Please confirm if you want:

- Option A: Local SDXL setup (I'll create the directory structure)
- Option B: Use hosted API instead

---

**File:** `docs/sdks/SDXL_INTEGRATION.md` ✅ Created
