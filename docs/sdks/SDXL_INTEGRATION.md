# ğŸ–¼ï¸ SDXL Integration Guide

**Version:** 1.0.0  
**Last Updated:** 2025-10-26  
**Module:** Image Generator (Module 9)

---

## ğŸ“ Location Decision

Based on DAG analysis and module dependencies:

### âœ… Recommended Structure

```
News-main/
â”œâ”€â”€ apps/
â”‚   â””â”€â”€ backend-cmmv/
â”‚       â””â”€â”€ modules/
â”‚           â””â”€â”€ image-generator/        # Image generation module
â”‚               â”œâ”€â”€ contracts/
â”‚               â”‚   â””â”€â”€ ImageContract.ts
â”‚               â”œâ”€â”€ services/
â”‚               â”‚   â””â”€â”€ sdxl-client.ts   # SDXL HTTP client
â”‚               â””â”€â”€ utils/
â”‚                   â””â”€â”€ image-processor.ts
â”‚
â””â”€â”€ storage/                            # External storage
    â””â”€â”€ images/                         # Generated images (MinIO/S3)
        â”œâ”€â”€ covers/                     # Cover images
        â”œâ”€â”€ thumbnails/                  # Thumbnail images
        â””â”€â”€ social/                     # Social media presets
```

### Why This Structure?

1. **Module 9 (Image Generator) is INSIDE backend-cmmv**
   - Located: `apps/backend-cmmv/modules/image-generator/`
   - Follows CMMV contract pattern
   - Service layer connects to SDXL

2. **Image Files are EXTERNAL**
   - Stored in MinIO/S3 bucket
   - Path: `s3://hivenews/images/{portal}/{type}/{id}.jpg`
   - NOT in git

3. **SDXL Models Stay Separate**
   - Recommendation: `News-main/sdxl/models/` (or external)
   - Models too large for git
   - Accessed by SDXL client

---

## ğŸ”— Module 9: Image Generator

### Contract: ImageContract

**Fields:**

```typescript
@Contract("Image")
export class ImageContract {
  @Field() id: string;
  @Field() article_id: string; // Links to ArticleContract
  @Field() style: string; // Portal-specific style
  @Field() prompt: string; // SDXL prompt used
  @Field() url_cover: string; // S3 URL for cover
  @Field() url_thumb: string; // S3 URL for thumbnail
  @Field() alt_text: string; // ALT text for SEO
  @Field() seo_relevance: number; // SEO score
}
```

### Dependencies (from DAG.md lines 212-217):

```
Article â†’ Writer/Translator â†’ Image Generator
                                â”‚
                                â”œâ”€â†’ Generate with SDXL
                                â”œâ”€â†’ Upload to MinIO/S3
                                â””â”€â†’ Store URLs in ImageContract
```

---

## ğŸ“‚ Folder Structure Connected to Module 9

### 1. Backend Module (Generate)

```typescript
// apps/backend-cmmv/modules/image-generator/
â”œâ”€â”€ contracts/
â”‚   â””â”€â”€ Image.contract.ts          // CMMV contract definition
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ SdxlClient.ts              // SDXL HTTP client
â”‚   â”œâ”€â”€ ImageProcessor.ts          // Image processing utilities
â”‚   â””â”€â”€ MinIOClient.ts             // S3 upload/download
â””â”€â”€ controllers/
    â””â”€â”€ ImageController.ts         // Auto-generated by CMMV
```

### 2. Storage Layer (Persist)

```typescript
// MinIO/S3 Bucket Structure
s3://hivenews/
â””â”€â”€ images/
    â”œâ”€â”€ airesearch/
    â”‚   â”œâ”€â”€ covers/
    â”‚   â”‚   â””â”€â”€ {article_id}.jpg
    â”‚   â”œâ”€â”€ thumbnails/
    â”‚   â”‚   â””â”€â”€ {article_id}_thumb.jpg
    â”‚   â””â”€â”€ social/
    â”‚       â”œâ”€â”€ x/
    â”‚       â”‚   â””â”€â”€ {article_id}_x.jpg
    â”‚       â””â”€â”€ linkedin/
    â”‚           â””â”€â”€ {article_id}_li.jpg
    â””â”€â”€ scienceai/
        â””â”€â”€ [same structure]
```

### 3. Database (Metadata)

```typescript
// PostgreSQL - ImageContract entity
images/
â””â”€â”€ id (PK)
â””â”€â”€ article_id (FK â†’ articles)
â””â”€â”€ url_cover (S3 URL)
â””â”€â”€ url_thumb (S3 URL)
â””â”€â”€ seo_relevance (FLOAT)
â””â”€â”€ created_at (TIMESTAMP)
```

---

## ğŸ”„ Data Flow

```
SDXL Generation Flow:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ArticleContract (id: "abc123")
  â†“
Image Generator triggered
  â†“
Generate with SDXL (from News-main/sdxl/models/)
  â†“
1. Cover image (1200x675) â†’ upload to MinIO â†’ get URL
2. Thumbnail (400x400) â†’ upload to MinIO â†’ get URL
3. Social presets â†’ upload to MinIO â†’ get URLs
  â†“
Create ImageContract record:
  - article_id: "abc123"
  - url_cover: "s3://hivenews/images/airesearch/covers/abc123.jpg"
  - url_thumb: "s3://hivenews/images/airesearch/thumbnails/abc123_thumb.jpg"
  â†“
Store in PostgreSQL
```

---

## ğŸ¯ What You Need to Do for SDXL

### Option A: Local SDXL (Recommended for Development)

**Installation:**

```bash
# 1. Create directory
mkdir News-main/sdxl
cd News-main/sdxl

# 2. Download models (or I can create download script)
# Models go in: sdxl/models/
# - sd_xl_base_1.0.safetensors
# - sd_xl_refiner_1.0.safetensors

# 3. Run SDXL server
python scripts/sdxl-server.py --port 7860
```

**Files Needed:**

- Models: `News-main/sdxl/models/*.safetensors` (~13.5 GB)
- Configs: `News-main/sdxl/configs/*.yaml` (create these)
- Server: `News-main/sdxl/scripts/sdxl-server.py` (I'll create this)

### Option B: Hosted SDXL (Production)

Use external SDXL API:

- Replicate.com
- Stability AI
- Hugging Face Inference API

---

## ğŸ“ Where SDXL Generates Images

1. **SDXL generates image** â†’ Temporary buffer
2. **Image uploaded to MinIO** â†’ `s3://hivenews/images/...`
3. **ImageContract stores URL** â†’ PostgreSQL
4. **Article references image** â†’ Via `article_id` FK

**Image files NEVER go in git.** Only metadata (URLs) are stored.

---

## ğŸ¨ Portal-Specific Configurations

### For each portal:

```yaml
# configs/portal-profiles/airesearch.yaml (already exists)
editorial:
  name: AIResearch
  image_style: "scientific, modern, tech-focused"
  cover_preset: "academic paper style"
  thumbnail_style: "minimalist, abstract"
```

This feeds into SDXL prompt generation.

---

## âœ… Summary for You

**Question:** Where should SDXL files go?

**Answer:**

1. **SDXL models:** `News-main/sdxl/models/` (or separate location if space limited)
2. **SDXL configs:** Will be created in `News-main/sdxl/configs/`
3. **Generated images:** Upload to MinIO/S3, NOT in git
4. **Image metadata:** Stored in ImageContract (PostgreSQL)

**Module:** Module 9 (Image Generator)  
**Location:** `apps/backend-cmmv/modules/image-generator/`  
**Connects to:** ArticleContract, MinIO/S3 storage, Publisher module

**Next Step:** Please confirm if you want:

- Option A: Local SDXL setup (I'll create the directory structure)
- Option B: Use hosted API instead

---

**File:** `docs/sdks/SDXL_INTEGRATION.md` âœ… Created
